<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Map Pointer Animator — Lasso Selection</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root {
      --accent: #ff3e00;
      --bg: #0f1724;
      --panel: #0b1220;
      --muted: #9aa4b2;
      --glass: rgba(255,255,255,0.03);
    }
    html, body, #map { height: 100%; margin: 0; }
    body {
      font-family: Inter, ui-sans-serif, system-ui;
      background: linear-gradient(180deg, var(--bg), #071023);
      color: #e6eef6;
      display: flex;
      flex-direction: column;
    }
    .topbar {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.02));
      box-shadow: 0 2px 10px rgba(2,6,23,0.6);
      z-index: 1000;
    }
    .controls { display: flex; gap: 8px; }
    button.btn {
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.04);
      color: inherit;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button.primary { background: linear-gradient(90deg, var(--accent), #ff6f3a); color: #081017; border: none; }
    button.warn { background: linear-gradient(90deg,#e25656,#ff7f7f); color:#071017 }
    #map { flex: 1; cursor: default; }
    .instructions {
      padding: 10px 16px;
      font-size: 13px;
      background: rgba(255,255,255,0.02);
      border-top: 1px solid rgba(255,255,255,0.02);
      color: var(--muted);
    }
    .map-pointer-icon { display: flex; align-items: center; justify-content: center }
  </style>
</head>
<body>
  <div class="topbar">
    <button id="selectBtn" class="btn">Lasso Select</button>
    <button id="animateBtn" class="btn primary" disabled>Animate Pointer</button>
    <button id="resetBtn" class="btn warn">Reset</button>
    <div id="status" class="info" style="margin-left:auto;font-size:13px;color:var(--muted)">Click "Lasso Select" then drag to draw a freeform area</div>
  </div>
  <div id="map"></div>
  <div class="instructions">Hold and drag to draw a freeform polygon. Release to finalize, then click Animate.</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let selecting = false;
    let lassoPoints = [];
    let lassoLine = null;
    let lassoPolygon = null;
    let marker = null;
    let anim = { running: false, raf: null };

    const selectBtn = document.getElementById('selectBtn');
    const animateBtn = document.getElementById('animateBtn');
    const resetBtn = document.getElementById('resetBtn');
    const status = document.getElementById('status');

    selectBtn.addEventListener('click', () => {
      if (lassoPolygon) map.removeLayer(lassoPolygon);
      lassoPoints = [];
      if (lassoLine) { map.removeLayer(lassoLine); lassoLine = null; }
      selecting = true;
      status.textContent = 'Lasso: click and drag to draw';
      map.getContainer().style.cursor = 'crosshair';
    });

    map.on('mousedown', (e) => {
      if (!selecting) return;
      lassoPoints = [e.latlng];
      if (lassoLine) map.removeLayer(lassoLine);
      lassoLine = L.polyline(lassoPoints, { color: 'orange', weight: 2 }).addTo(map);
      map.dragging.disable();
      map.on('mousemove', onMouseMove);
    });

    function onMouseMove(e) {
      if (!selecting) return;
      lassoPoints.push(e.latlng);
      lassoLine.setLatLngs(lassoPoints);
    }

    map.on('mouseup', () => {
      if (!selecting) return;
      map.off('mousemove', onMouseMove);
      map.dragging.enable();
      if (lassoLine) {
        // close polygon
        lassoPolygon = L.polygon(lassoPoints, { color: getComputedStyle(document.documentElement).getPropertyValue('--accent'), weight: 2 }).addTo(map);
        map.removeLayer(lassoLine);
        lassoLine = null;
        selecting = false;
        animateBtn.disabled = false;
        status.textContent = 'Area selected — ready to animate';
      }
      map.getContainer().style.cursor = '';
    });

    resetBtn.addEventListener('click', () => {
      cancelAnimation();
      if (lassoPolygon) { map.removeLayer(lassoPolygon); lassoPolygon = null; }
      if (marker) { map.removeLayer(marker); marker = null; }
      animateBtn.disabled = true;
      status.textContent = 'Selection cleared';
    });

    animateBtn.addEventListener('click', () => {
      if (!lassoPolygon) return;
      startAnimation();
    });

    function randomPointInPolygon(polygon) {
      // naive rejection sampling within polygon bbox
      const bounds = polygon.getBounds();
      const sw = bounds.getSouthWest(), ne = bounds.getNorthEast();
      let pt;
      do {
        const lat = sw.lat + Math.random() * (ne.lat - sw.lat);
        const lng = sw.lng + Math.random() * (ne.lng - sw.lng);
        pt = L.latLng(lat, lng);
      } while (!leafletPip.pointInLayer([pt.lng, pt.lat], polygon).length);
      return pt;
    }

    // minimal point-in-polygon using ray casting
    function pointInPolygon(latlng, poly) {
      const x = latlng.lng, y = latlng.lat;
      const vs = poly.getLatLngs()[0];
      let inside = false;
      for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        const xi = vs[i].lng, yi = vs[i].lat;
        const xj = vs[j].lng, yj = vs[j].lat;
        const intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function randomLatLngInPolygon(poly) {
      const bounds = poly.getBounds();
      let candidate;
      do {
        candidate = L.latLng(
          bounds.getSouthWest().lat + Math.random() * (bounds.getNorthEast().lat - bounds.getSouthWest().lat),
          bounds.getSouthWest().lng + Math.random() * (bounds.getNorthEast().lng - bounds.getSouthWest().lng)
        );
      } while (!pointInPolygon(candidate, poly));
      return candidate;
    }

    async function startAnimation() {
      cancelAnimation();
      anim.running = true;
      animateBtn.disabled = true;
      animateBtn.textContent = 'Animating...';

      const waypoints = Array.from({length: 10}, () => randomLatLngInPolygon(lassoPolygon));
      const final = randomLatLngInPolygon(lassoPolygon);
      waypoints.push(final);

      let current = marker ? marker.getLatLng() : randomLatLngInPolygon(lassoPolygon);
      if (marker) marker.setLatLng(current);
      else marker = L.marker(current, { icon: createPointerIcon(40) }).addTo(map);

      const totalDuration = 4000;
      const perSegment = totalDuration / waypoints.length;

      for (let s = 0; s < waypoints.length && anim.running; s++) {
        const next = waypoints[s];
        const startTime = performance.now();
        const endTime = startTime + perSegment;
        await new Promise(resolve => {
          function step(now) {
            if (!anim.running) return resolve();
            const t = Math.min(1, (now - startTime) / (endTime - startTime));
            const lat = current.lat + (next.lat - current.lat) * t;
            const lng = current.lng + (next.lng - current.lng) * t;
            marker.setLatLng([lat, lng]);
            if (t >= 1) { current = next; return resolve(); }
            anim.raf = requestAnimationFrame(step);
          }
          anim.raf = requestAnimationFrame(step);
        });
      }
      anim.running = false;
      marker.setLatLng(final);
      animateBtn.disabled = false;
      animateBtn.textContent = 'Animate Pointer';
    }

    function createPointerIcon(size=36){
      const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff3e00';
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2L15 11H9L12 2z"/><circle cx="12" cy="16" r="3" fill="currentColor" /></svg>`;
      return L.divIcon({
        className: 'map-pointer-icon',
        html: `<div style="color:${accent}">${svg}</div>`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
      });
    }

    function cancelAnimation(){
      anim.running = false;
      if (anim.raf) cancelAnimationFrame(anim.raf);
      anim.raf = null;
    }
  </script>
</body>
</html>
